# Python CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-python/ for more details
#
version: 2.1
jobs:
  build:
    docker:
      # specify the version you desire here
      # use `-browsers` prefix for selenium tests, e.g. `3.6.1-browsers`
      - image: google/cloud-sdk
        #circleci/python:3.8
      
      # Specify service dependencies here if necessary
      # CircleCI maintains a library of pre-built images
      # documented at https://circleci.com/docs/2.0/circleci-images/
      # - image: circleci/postgres:9.4

    working_directory: ~/repo

    steps:
      - checkout

      # Download and cache dependencies
      - restore_cache:
          keys:
          - v1-dependencies-{{ checksum "requirements.txt" }}
          # fallback to using the latest cache if no exact match is found
          - v1-dependencies-

      - run:
          name: install dependencies
          command: |
            apt install -y python3-venv
            python3 -m venv venv
            . venv/bin/activate
            python3 -m pip install --upgrade pip
            pip3 install -r requirements.txt
        # python3 -m venv venv
        # . venv/bin/activate
        # pip3 install -r requirements.txt
      - save_cache:
          paths:
            - ./venv
          key: v1-dependencies-{{ checksum "requirements.txt" }}
        
      # run tests!
      - run:
          name: run tests
          command: |
            . venv/bin/activate
            make test
      # run lints!
      - run:
          name: run lint
          command: |
            . venv/bin/activate
            make lint
      # deplot to GCP!
      - run:
          name: deploy to app engine
          command: |
            echo ${GCLOUD_SERVICE_KEY} | gcloud auth activate-service-account project434@myproject434-355720.iam.gserviceaccount.com --key-file="ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAibXlwcm9qZWN0NDM0LTM1NTcyMCIsCiAgInByaXZhdGVfa2V5X2lkIjogIjEyYzgxMTVjN2YyNDkzMGFjY2U3NmZiOWMxNzY1N2VjMWRmMmM0MmIiLAogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV1Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktRd2dnU2dBZ0VBQW9JQkFRQ3QydmR2bUcyUmwvdjNcbk9IbFVxME16TUpxRGFjWnFOVGlKS0RSbVlwc1BvWDNqTkpGQlBsQVhESmpzYmhtNHNISW1SL3M2dkgwSnBkUFBcbi9Dcnk4NGZOcFcvcjdvMWtKU1BTY2pIUUM3QUd0MGk3SlE0RktNaU96amU2SzVnK3QvRW9mV1RIMk1vYjMwVjhcbjh1VTJUVzhPSlRBZHM0NmtNSnZpNEFMREo4bGFCZFJlZVJUQis2aHZXL1VRSVU1ZjBLRW84cnAxUklpRHVMejdcbkVUS1RCMy9MczdxNmdMdy9JcDA1b2pWT2prRk90ZWtIZjM2RWkzNUhjUmJTT0h1RUxVMGQ5anlQbjIrTjVVTHhcbnk5UDF1d1FGS3hsREFibW5FNUpEUjJ2VllZdkFVMENHNXVwL3RTbEtibHZOQ0lkNUZadzE1L3JUMXRtSGp0NHpcbm4yUDIwU1pGQWdNQkFBRUNnZjlwSGVsOW9pd0xOelV6eFFQZ1pJZ0dOSlBLS2p5V3NidTBEYTFYOFViUDljSmVcbnNBNlJDTUN0THdMK09pWUtCVGVSeVQwTE5EVkJSS2NEdnFzVXFBWFAwVW5JU3MrZ1BXYkd4UHZIQlpNeDZnMlBcbnJBNjd4cllQRCttaDNibjR4RDdVdkdvZ3RITTErVWxCVlZKQmNMVEhXTFRSUUlqSGRGTmU2KzR0V2p4Mlo2Q3hcblZEY2hYUUJnaHNuT29FTW0yOGQ3enJpR1RQUWpLeEVNaGtxNml2TitkRWptTTNIK1ZLSWRMeXdESFZwQi9KSHFcbmpkV2JteUdOR2NxQnJ1ZjMrZnhVY3V2c3g4YVNFZnBYWnhkbGplT2syYWI3NEVKQU50dFd1enFidlpQS2lZWnNcbklKVytRUk1FTDdQd01Wa2lRY09QM01lenZhdmJCSitEWVpENU8xY0NnWUVBOGdKSjRxYVFqeTNoTUtqWDhoZ1hcbkdSckR5b1FSYTZUNVA0RkVEREdPYVFWeDlGTXBCWWttUllWMHViSzUvSnBuZENaa0xXbEdMdHdWUklKbDUzVStcblhrVktJVHNTWExGWTVQb1pnVllkRmlmc3dTNU9UWisyd0YrT3huVkhxMC9oc2FyQjhlQXVnSWd5bWw5TlFtOG9cbnhOcFI5S1AxRE5ZeXJtWURhY0VmWFljQ2dZRUF0K2dDc1VuVmNHV1ZNVDdLSWJLc2lGRUYxNlhMTUhjUFA2K2pcbmVab1kzWWs0R1hXSzR5bW9JM1lhbEs3WSt6TGNDQjV6UkkxOUI1RzVTcUg0Sy9kRGwvdURLNXI2OW1hcTRrNjVcblNTWm50RnZYNXk1b1c5N2k5azVBZ2hUbUxqejd1ZTJjM2VjSEkyaWNKV2JRNHllanhDbzdqcVVuOGZ0NDdkVHRcblBjbVVjTk1DZ1lCSVdQYk5rdzNVUDlyNk9QK1ZtQzRQaXpqTTZmNXJONzVyaGJGYUU5YUcvdUc2TU1JcXJYMkxcbmV3SVNJYVFJS0FDVmNJU3lMcTZVZzZhMy9HT0tkanBXNUUvczcwUG1BZjZaTlVzNnB3dTYrK1NETzl5Y3lBcFNcbktENytoVUVQcmFuQysxRlBoYjFoSDFaQllBd3d1QnB2L3ZSUk5sS2pxOFVxN2NSSGNUeDNNUUtCZ0dMdnJTc2xcbmRtN3VKMUlEM29nOGNEY3hwM3Y1RkpPeEtZSHdnbml6M3ZhbmtJZVp4YXNweU91eTZOL2VKSnNYSkdvMXYzczhcbnh1dWdpTmRPeFkwWmk4S2lxMUYxSWRnWEtZMXdIcHZzemxPb0tVR1VwTTN2M1pmMlJ4djBGRlVCdDhheHZ2ZGVcbkIyZ1VLaFN3K0dXTCtMMWFud25CYmZqdmVZSXhUNlF5NHVuREFvR0FXU0pDZ1UyTHo3V1p2WlNtUXpWK0tMMzdcbkkzWnJzc2wrRDlGaHJHd3lFeGsvcWE5WXhCbVVQODVTY0pDTk1OOHIzbFo0MFUraFpmOG5zem9oSUlOVG5JQWNcbkxUZGphdlhZSmJqYzZ1aTYrT0JKMnBqVDlheHZJclExZ1lWbW5uY0tsSDBrVmVzaEVJUm1KK0V4bC9lbEJmOExcbjkwUnU1NS93SGZTMG10eVc0cVU9XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAicHJvamVjdDQzNEBteXByb2plY3Q0MzQtMzU1NzIwLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjEwNDA3MzExMzMwMTE2MjU2ODcxNiIsCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvcHJvamVjdDQzNCU0MG15cHJvamVjdDQzNC0zNTU3MjAuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iCn0K"
            gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
            gcloud --quiet config set compute/zone ${GOOGLE_COMPUTE_ZONE}
            cd gcloud app deploy
